inherit: [buildenv, werror, capigen, patch]

metaEnvironment:
   PKG_LICENSE: "proprietary-pcc"
   PKG_RESPONSIBLE: "System-System"

checkoutSCM:
 - scm: git
   url: git@${DEFAULT_PCC_GIT_SERVER}:tip-communication/tsd.commonapi.testframework.git
   dir: tsd.commonapi.testframework
   branch: master

checkoutDeterministic: True
checkoutScript: |
   CapiGenTFWProcessFIDLFiles tsd.commonapi.testframework
   # Fix any autogenerated file that needs a modification to work correctly.
   patchApplySeries $<<tsd-commonapi-testframework/*.patch>>

buildScript: |
   copyAllLibs() {
      # Copy all libs so we can provide them (the dirty way)
      mkdir -p dist/usr/lib
      mkdir -p dist/usr/lib64

      for i in $*; do
         cp -R ${i}/usr/lib/* dist/usr/lib 2> /dev/null || true
         cp -R ${i}/usr/lib64/* dist/usr/lib64 2> /dev/null || true
      done
   }

multiPackage:
   "":
      depends:
         - use: [tools]
           depends:
              - toolchain::bats
              - communication::tsd-commonapi-testframework-root
              - communication::tsd-commonapi-testframework-tests

      buildTools: [bats, testframework-root, testframework-tests]
      buildScript: |
         rm -rf communication
         mkdir -p communication/tsd-commonapi-testframework/dist/1/
         bats $1/tsd.commonapi.testframework/bats/ --cppunit > communication/tsd-commonapi-testframework/dist/1/tsd.commonapi.testframework.cppunitreport || true

      packageScript: |
         rsync -a --delete $1/communication .
         rsync -a --delete --ignore-missing-args $1/*.valgrind_result .

   root:
      depends:
         - system::tsd-common-daemon-dev
         - communication::tsd-communication-dev
         - use: []
           depends:
              - system::tsd-common-daemon-target
              - communication::tsd-communication-target

      privateEnvironment:
         CXXFLAGS: "${CXXFLAGS} -Wno-deprecated-declarations"
      buildScript: |
         buildenvBuildAll -DFEATURE_TSD_COMMONAPI_TESTFRAMEWORK_PART=ROOT
         copyAllLibs $*

      packageScript: buildenvPackageTarget
      provideTools:
         testframework-root:
            path: "usr/bin"
            libs: [ "usr/lib", "usr/lib64" ]
      provideDeps: ['*-target']

   tests:
      depends:
         - communication::ext-commonapi-runtime-dev
         - communication::tsd-communication-binding-dev
         - use: []
           depends:
              - communication::ext-commonapi-runtime-target
              - communication::tsd-communication-binding-target

      privateEnvironment:
         CXXFLAGS: "${CXXFLAGS} -Wno-deprecated-declarations"
      buildScript: |
         buildenvBuildAll -DFEATURE_TSD_COMMONAPI_TESTFRAMEWORK_PART=TESTS
         copyAllLibs $*

      packageScript: buildenvPackageTarget
      provideTools:
         testframework-tests:
            path: "usr/bin"
            libs: [ "usr/lib", "usr/lib64" ]
      provideDeps: ['*-target']
