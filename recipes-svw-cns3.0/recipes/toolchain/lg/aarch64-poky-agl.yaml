metaEnvironment:
   PKG_RESPONSIBLE: "Navigation-Vorintegration"

environment:
   TOOLCHAIN_NAME: "poky-agl-glibc-x86_64-mib3-mqb-vw-image-aarch64-toolchain-3.0.0+snapshot_ES18_20181129.sh"
   TOOLCHAIN_HASH: "4f8a8df7268cb110cc86521c04543f5245d01929"
   URL:            "${DEFAULT_DOWNLOAD_SCM_URL}src/toolchain/lg/"
   ARM_ROOTFS:     "aarch64-agl-linux"

shared: True
checkoutSCM:
   - scm: url
     url: ${URL}${TOOLCHAIN_NAME}
     digestSHA1: ${TOOLCHAIN_HASH}
   - scm: git #needed because of: "Parse error: Shared packages must be deterministic!"
     url: git@${DEFAULT_PCC_GIT_SERVER}:tip-integration/TSD.BUILDENV.git
     dir: tsd.buildenv
     tag: 3.0.0



buildScript: |
   ln -sf $1/*sh
   ln -sf $1/*tar.gz
   cp $1/tsd.buildenv/bin/tsd-buildenv-create-shim.sh .
   #cp $1/*sh .


packageVars: [TOOLCHAIN_NAME, ARM_ROOTFS]
packageScript: |
   #ln -sf $1/*sh
   cp $1/*sh .
   chmod +x ${TOOLCHAIN_NAME}
   if [ ! -e sysroots ] ; then
      #fetchToolchain
      echo $PWD
      ./$TOOLCHAIN_NAME -y -d .
      rm $TOOLCHAIN_NAME
      rm -rf sysroots/*/usr/src
      sed -i -e 's/_GLIBCXX_DEPRECATED//' sysroots/aarch64-agl-linux/usr/include/c++/*/backward/auto_ptr.h
      rm -f sysroots/x86_64-aglsdk-linux/usr/bin/pkg-config
   fi
   # add sysroot for compiler and linker
   mkdir -p bin
   for i in ld ld.bfd; do
      cat > bin/aarch64-agl-linux-$i <<EOF
   #!/bin/sh
   \${0%/*}/../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-$i --sysroot=\${0%/*}/../sysroots/$ARM_ROOTFS "\$@"
   EOF
      chmod a+x bin/aarch64-agl-linux-$i
   done

   for i in gcc g++ cpp; do
      cat > bin/aarch64-agl-linux-$i <<EOF
   #!/bin/sh
   \${COMPILER_PREFIX:- } \${0%/*}/../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-$i --sysroot=\${0%/*}/../sysroots/$ARM_ROOTFS "\$@"
   EOF
      chmod a+x bin/aarch64-agl-linux-$i
   done

   # just symlink the rest
   pushd bin
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-ar
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-as
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-gdb
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-nm
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-objcopy
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-objdump
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-ranlib
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-readelf
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-strip
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-size
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/aarch64-agl-linux/aarch64-agl-linux-strings
   ln -sf ../sysroots/x86_64-aglsdk-linux/usr/bin/pkg-config
   popd

   pushd sysroots/aarch64-agl-linux/usr/lib64
   #ln -sf libEGL.so      libEGL.so.1
   #ln -sf libGLESv2.so   libGLESv2.so.2
   pushd weston
   ln -sf ivi-controller.so libivi-controller.so
   ln -sf ivi-shell.so libivi-shell.so
   ln -sf hmi-controller.so libhmi-controller.so
   #ln -sf wayland-backend.so libwayland-client.so
   popd
   popd
   pushd sysroots/aarch64-agl-linux/usr/include
      cp -f wayland-* weston/
      cp -f ivi-application-client-protocol.h weston/
   popd

   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64 -l ilmClient -L lib64/weston -l ivi-controller -I include -I include/weston ext.weston
   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64/weston -l hmi-controller -I include -I include/weston ext.weston.hmi
   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64 -I include -l wayland-client ext.wayland.client
   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64 -I include -l wayland-server ext.wayland.server
   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64 -I include -d ext.wayland.client -l wayland-egl ext.wayland.egl
   ./tsd-buildenv-create-shim.sh -p sysroots/aarch64-agl-linux/usr -L lib64 -I include -l EGL -l GLESv2 ext.opengles

   # create toolchain file
   cat > linux_linux-poky_armv8.toolchain <<EOF
   # tell cmake the name of our target system
   set (CMAKE_SYSTEM_NAME "Linux")

   # set compiler
   SET(CMAKE_C_COMPILER   "aarch64-agl-linux-gcc")
   SET(CMAKE_CXX_COMPILER "aarch64-agl-linux-g++")

   # set root path
   SET(CMAKE_SYSROOT "${PWD}/sysroots/${ARM_ROOTFS}")

   SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER CACHE INTERNAL "")
   SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY CACHE INTERNAL "")
   SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY CACHE INTERNAL "")
   EOF

provideVars:
   # architecture
   ARCH: arm64
   AUTOCONF_HOST:   "aarch64-agl-linux"
   AUTOCONF_TARGET: "aarch64-agl-linux"
   CROSS_COMPILE: aarch64-agl-linux-
   TARGET_TYPE: "embedded"
   TARGET_ENVIRONMENT: "lg"

   # compiler settings
   CMAKE_TARGET_FILE: "armv8_linux.cmake"
   CMAKE_TOOLCHAIN_FILE: "../linux_linux-poky_armv8.toolchain"
   CFLAGS: " -O2 -pipe -g -feliminate-unused-debug-types -ffunction-sections -fdata-sections  "
   CXXFLAGS: "-std=c++11 -O2 -pipe -g -feliminate-unused-debug-types  -DMIB3_MQB=1 -DMIB3_VW=1 -DMIB3_MQB_VW=1 -DMIB3_MQB_SE=0 -DMIB3_MQB37_VW=0 -DMIB3_MQB37_SE=0 -ffunction-sections -fdata-sections  "
   LDFLAGS: "-Wl,-O1 -Wl,--hash-style=gnu -Wl,--as-needed"
   CPPFLAGS: ""
   LIBDIR: lib64
   SYSROOT: "../sysroots/${ARM_ROOTFS}"

   # tools
   AR:     "aarch64-agl-linux-ar"
   AS:     "aarch64-agl-linux-as"
   CC:     "aarch64-agl-linux-gcc"
   CPP:    "aarch64-agl-linux-cpp"
   CXX:    "aarch64-agl-linux-g++"
   GDB:    "aarch64-agl-linux-gdb"
   LD:     "aarch64-agl-linux-ld"
   OBJCPY: "aarch64-agl-linux-objcopy"
   OBJDMP: "aarch64-agl-linux-objdump"
   RANLIB: "aarch64-agl-linux-ranlib"
   STRIP:  "aarch64-agl-linux-strip"

provideTools:
   toolchain:
      path: "bin"
