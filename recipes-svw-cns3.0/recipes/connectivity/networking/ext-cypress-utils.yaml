inherit: [install, make, packing-module]

metaEnvironment:
   PKG_LICENSE: "proprietary"
   PKG_VERSION: "release_2016-03-15"
   PKG_PATCH_VERSION: "1.0.0_pcc1"
   PKG_RESPONSIBLE: "Connect-Connection"

checkoutSCM:
 - scm: git
   url: git@${DEFAULT_PCC_GIT_SERVER}:tip-libs/ext.cypress.utils.git
   dir: ext.cypress.utils
   tag: 1.0.0_pcc1

buildVars: [CROSS_COMPILE, ARCH, CC, CXX, CPP]
buildTools: [toolchain]
buildScript: |
   # copy sources from src to build
   rsync -a --delete $1/ext.cypress.utils/ .

   # get rid of Werror...
   find . -iname "*makefile" -exec sed -i 's/-Werror//g' {} \;

   # build wl and dhd
   pushd ${PWD}/utility/src/wl/exe
   make clean
   makeParallel
   popd

   pushd ${PWD}/utility/src/dhd/exe
   make clean
   makeParallel
   popd

multiPackage:
   dhd:
      packageScript: |
         mkdir -p usr/bin
         cp -a $1/utility/src/dhd/exe/dhd usr/bin
         installStripAll usr/bin

         d=$(mktemp -d)
         rsync -a --delete ./ $d
         buildSwupModule -n "ext-cypress-utils-dhd" \
            -p "emmc.connectivity.netwg" \
            -o "connectivity.networking:ext-cypress-utils " -f $d -- \
            -U "Partition=rootfs_ro"
         rm -rf $d
   wl:
      packageScript: |
         mkdir -p usr/bin
         cp -a $1/utility/src/wl/exe/wl usr/bin
         installStripAll usr/bin

         d=$(mktemp -d)
         rsync -a --delete ./ $d
         buildSwupModule -n "ext-cypress-utils-wl" \
            -p "emmc.connectivity.netwg" \
            -o "connectivity.networking:ext-cypress-utils " -f $d -- \
            -U "Partition=rootfs_ro"
         rm -rf $d
