From 97dab71b1db52e2bd046b7fcbec07b7c06330ff5 Mon Sep 17 00:00:00 2001
From: Karsten Heinze <karsten.heinze@preh.de>
Date: Mon, 5 Feb 2018 11:06:14 +0100
Subject: [PATCH 4/4] Don't call s_log() in ssl_init().

Otherwise stunnel crashes. Luckily this only
affects error messages.
---
 src/ssl.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/ssl.c b/src/ssl.c
index 34f4529..bdd7db5 100644
--- a/src/ssl.c
+++ b/src/ssl.c
@@ -49,6 +49,8 @@ NOEXPORT int add_rand_file(GLOBAL_OPTIONS *, const char *);
 
 int index_cli, index_opt, index_redirect, index_addr;
 
+// Logging in ssl_init() is borken as SSL locks are created later!
+// So just use fprintf() here to print warnings and errors.
 int ssl_init(void) { /* init TLS before parsing configuration file */
 #if OPENSSL_VERSION_NUMBER>=0x10100000L
     OPENSSL_init_ssl(OPENSSL_INIT_LOAD_SSL_STRINGS |
@@ -66,7 +68,7 @@ int ssl_init(void) { /* init TLS before parsing configuration file */
     index_addr=SSL_SESSION_get_ex_new_index(0, "addr index",
         NULL, NULL, cb_free);
     if(index_cli<0 || index_opt<0 || index_redirect<0 || index_addr<0) {
-        s_log(LOG_ERR, "Application specific data initialization failed");
+        fprintf(stderr, "ERROR: Application specific data initialization failed\n");
         return 1;
     }
 #ifndef OPENSSL_NO_ENGINE
@@ -75,7 +77,7 @@ int ssl_init(void) { /* init TLS before parsing configuration file */
 #ifndef OPENSSL_NO_DH
     dh_params=get_dh2048();
     if(!dh_params) {
-        s_log(LOG_ERR, "Failed to get default DH parameters");
+        fprintf(stderr, "ERROR: Failed to get default DH parameters\n");
         return 1;
     }
 #endif /* OPENSSL_NO_DH */
-- 
2.11.0

