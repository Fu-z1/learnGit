inherit: [install, make, patch, packing-module]

environment:
   PKG_VERSION: "1.0.6"

checkoutVars: [PKG_VERSION]
checkoutSCM:
   scm: url
   url: ${DEFAULT_DOWNLOAD_SCM_URL}src/ext-bzip2/bzip2-${PKG_VERSION}.tar.gz
   digestSHA1: "3f89f861209ce81a6bab1fd1998c0ef311712002"

checkoutDeterministic: true
checkoutScript: |
   pushd bzip2-${PKG_VERSION}
   patchApplySeries -p0 $<<ext-bzip2/*.patch>>
   sed -i \
      -e 's:\$(PREFIX)/man:\$(PREFIX)/share/man:g' \
      -e 's:ln -s -f $(PREFIX)/bin/:ln -s -f :' \
      -e 's:$(PREFIX)/lib:$(PREFIX)/$(LIBDIR):g' \
      Makefile || false
   popd

buildVars: [PKG_VERSION, LIBDIR, AR, CC, RANLIB]
buildTools: [toolchain]
buildScript: |
   mkdir -p build install

   pushd build
   rsync -a --delete $1/bzip2-${PKG_VERSION}/ .
   makeParallel -f Makefile-libbz2_so all AR=$AR CC=$CC RANLIB=$RANLIB
   # Make sure we link against the shared lib #504648
   ln -sf libbz2.so.${PKG_VERSION} libbz2.so
   makeParallel install PREFIX=${PWD}/../install/usr AR=$AR CC=$CC RANLIB=$RANLIB

   cp -v bzip2-shared ${PWD}/../install/usr/bin/bzip2
   cp -v -a libbz2.so* ${PWD}/../install/usr/${LIBDIR}
   rm -v ${PWD}/../install/usr/bin/{bunzip2,bzcat}
   rm -v ${PWD}/../install/usr/${LIBDIR}/libbz2.a
   ln -v ${PWD}/../install/usr/bin/bzip2 ${PWD}/../install/usr/bin/bunzip2
   ln -v ${PWD}/../install/usr/bin/bzip2 ${PWD}/../install/usr/bin/bzcat
   popd

multiPackage:
   dev:
      packageTools: [buildenv]
      packageScript: |
         installPackageDev $1/install/
         tsd-buildenv-create-shim.sh -p usr -L ${LIBDIR} -l bz2 -I include ext.bzip2

   target:
      packageScript: |
         rsync -r --links --delete $1/install/ .
         shopt -s extglob
         rm -rf usr/!(lib|lib64)
         installStripAll usr
         d=$(mktemp -d)
         rsync -a --delete --exclude ".debug" ./ $d
         buildSwupModule -n "ext-bzip2" \
            -p "emmc.libs" \
            -o "libs:ext-bzip2 " -f $d -- \
            -U "Partition=rootfs_ro"
         rm -rf $d
