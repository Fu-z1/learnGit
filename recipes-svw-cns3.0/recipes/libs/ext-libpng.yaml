inherit: [autotools, packing-module]

environment:
   PKG_VERSION: "1.6.36"

depends:
  - libs::ext-zlib-dev
  - use: []
    depends:
      - libs::ext-zlib-target

checkoutVars: [PKG_VERSION]
checkoutSCM:
   scm: url
   url: ${DEFAULT_DOWNLOAD_SCM_URL}src/ext-libpng/libpng-${PKG_VERSION}.tar.xz
   digestSHA1: "aec9548c8319104226cc4c31d1f5e524f1b55295"

buildScript: |
   export CPPFLAGS="-I${BOB_DEP_PATHS[libs::ext-zlib-dev]}/usr/include"

   case ${AUTOCONF_HOST} in
      aarch64-*|arm-*)
         autotoolsBuild $1/libpng-${PKG_VERSION} --enable-arm-neon
         ;;
      *)
         autotoolsBuild $1/libpng-${PKG_VERSION}
         ;;
   esac

   # XXX: work around legacy software that accesses internal structures
   cp $1/libpng-${PKG_VERSION}/pnginfo.h dist/usr/include/
   cp $1/libpng-${PKG_VERSION}/pngstruct.h dist/usr/include/

multiPackage:
   dev:
      packageTools: [buildenv]
      packageScript: |
         autotoolsPackageDev
         tsd-buildenv-create-shim.sh -p usr -L ${LIBDIR} -I include -l png -d ext.zlib ext.libpng
      provideDeps: ['*-dev']

   target:
      packageScript: |
         autotoolsPackageTarget
         d=$(mktemp -d)
         rsync -a --delete --exclude ".debug" ./ $d
         buildSwupModule -n "ext-libpng" \
            -p "emmc.libs" \
            -o "libs:ext-libpng " -f $d -- \
            -U "Partition=rootfs_ro"
         rm -rf $d
      provideDeps: ['*-target']
