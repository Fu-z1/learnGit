inherit: [autotools, patch, packing-module]

metaEnvironment:
   PKG_RESPONSIBLE: "AMB-Audio"
   PKG_LICENSE: "MIT"

privateEnvironment:
   PKG_VERSION: "0.12.1"

checkoutSCM:
   scm: url
   url: ${DEFAULT_DOWNLOAD_SCM_URL}src/ext-json-c/json-c-${PKG_VERSION}.tar.gz
   digestSHA1: "e7fcdbe41f1f3307c036f4e9e04b715de533896e"

checkoutVars: [PKG_VERSION]
checkoutDeterministic: true
checkoutScript: |
   pushd json-c-${PKG_VERSION}
   patchApplySeries -p1 $<<ext-json-c/*.patch>>
   popd


buildVars: [PKG_VERSION, CONFIG_OPTIONS]
buildScript: |
   export ac_cv_func_malloc_0_nonnull=yes
   export ac_cv_func_realloc_0_nonnull=yes

   rsync -a --delete $1/json-c-${PKG_VERSION}/ $PWD

   autogenOrConfigure ./autogen.sh ${PWD} ${CONFIG_OPTIONS:-}
   autotoolsBuildOnly ${PWD}

multiPackage:
   ? ""
   :  environment:
         CONFIG_OPTIONS: ""
      multiPackage:
         dev: &dev
            packageTools: [buildenv]
            packageScript: |
               autotoolsPackageDev
               tsd-buildenv-create-shim.sh -p usr -L ${LIBDIR} -l json-c -I include ext.json-c

         target:
            packageScript: |
               autotoolsPackageTarget
               d=$(mktemp -d)
               rsync -a --delete --exclude ".debug" ./ $d
               buildSwupModule -n "ext-json-c" \
                  -p "emmc.audio.audiortr" \
                  -o "audio.audiorouter:ext-json-c " -f $d -- \
                  -U "Partition=rootfs_ro"
               rm -rf $d

   static:
      environment:
         CONFIG_OPTIONS: "--enable-static"
      multiPackage:
         dev: *dev
         target:
            packageScript: |
               # NOP
